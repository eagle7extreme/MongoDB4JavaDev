<html><head><title>Untitled document</title><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">ol.lst-kix_dgiphh7kofmx-4.start{counter-reset:lst-ctn-kix_dgiphh7kofmx-4 0}ol.lst-kix_dgiphh7kofmx-8{list-style-type:none}ol.lst-kix_dgiphh7kofmx-7{list-style-type:none}.lst-kix_dgiphh7kofmx-1>li:before{content:"" counter(lst-ctn-kix_dgiphh7kofmx-1,lower-latin) ". "}.lst-kix_dgiphh7kofmx-7>li:before{content:"" counter(lst-ctn-kix_dgiphh7kofmx-7,lower-latin) ". "}.lst-kix_dgiphh7kofmx-8>li:before{content:"" counter(lst-ctn-kix_dgiphh7kofmx-8,lower-roman) ". "}.lst-kix_dgiphh7kofmx-1>li{counter-increment:lst-ctn-kix_dgiphh7kofmx-1}.lst-kix_dgiphh7kofmx-0>li:before{content:"" counter(lst-ctn-kix_dgiphh7kofmx-0,decimal) ". "}.lst-kix_dgiphh7kofmx-5>li{counter-increment:lst-ctn-kix_dgiphh7kofmx-5}ol.lst-kix_dgiphh7kofmx-3.start{counter-reset:lst-ctn-kix_dgiphh7kofmx-3 0}.lst-kix_dgiphh7kofmx-2>li:before{content:"" counter(lst-ctn-kix_dgiphh7kofmx-2,lower-roman) ". "}.lst-kix_dgiphh7kofmx-7>li{counter-increment:lst-ctn-kix_dgiphh7kofmx-7}.lst-kix_dgiphh7kofmx-3>li{counter-increment:lst-ctn-kix_dgiphh7kofmx-3}.lst-kix_dgiphh7kofmx-4>li:before{content:"" counter(lst-ctn-kix_dgiphh7kofmx-4,lower-latin) ". "}.lst-kix_dgiphh7kofmx-0>li{counter-increment:lst-ctn-kix_dgiphh7kofmx-0}.lst-kix_dgiphh7kofmx-3>li:before{content:"" counter(lst-ctn-kix_dgiphh7kofmx-3,decimal) ". "}.lst-kix_dgiphh7kofmx-6>li:before{content:"" counter(lst-ctn-kix_dgiphh7kofmx-6,decimal) ". "}.lst-kix_dgiphh7kofmx-8>li{counter-increment:lst-ctn-kix_dgiphh7kofmx-8}ol.lst-kix_dgiphh7kofmx-5.start{counter-reset:lst-ctn-kix_dgiphh7kofmx-5 0}ol.lst-kix_dgiphh7kofmx-7.start{counter-reset:lst-ctn-kix_dgiphh7kofmx-7 0}ol.lst-kix_dgiphh7kofmx-2.start{counter-reset:lst-ctn-kix_dgiphh7kofmx-2 0}.lst-kix_dgiphh7kofmx-6>li{counter-increment:lst-ctn-kix_dgiphh7kofmx-6}ol.lst-kix_dgiphh7kofmx-0.start{counter-reset:lst-ctn-kix_dgiphh7kofmx-0 0}.lst-kix_dgiphh7kofmx-4>li{counter-increment:lst-ctn-kix_dgiphh7kofmx-4}ol.lst-kix_dgiphh7kofmx-6.start{counter-reset:lst-ctn-kix_dgiphh7kofmx-6 0}.lst-kix_dgiphh7kofmx-5>li:before{content:"" counter(lst-ctn-kix_dgiphh7kofmx-5,lower-roman) ". "}ol.lst-kix_dgiphh7kofmx-1.start{counter-reset:lst-ctn-kix_dgiphh7kofmx-1 0}ol.lst-kix_dgiphh7kofmx-3{list-style-type:none}ol.lst-kix_dgiphh7kofmx-4{list-style-type:none}ol.lst-kix_dgiphh7kofmx-8.start{counter-reset:lst-ctn-kix_dgiphh7kofmx-8 0}ol.lst-kix_dgiphh7kofmx-5{list-style-type:none}ol.lst-kix_dgiphh7kofmx-6{list-style-type:none}.lst-kix_dgiphh7kofmx-2>li{counter-increment:lst-ctn-kix_dgiphh7kofmx-2}ol.lst-kix_dgiphh7kofmx-0{list-style-type:none}ol.lst-kix_dgiphh7kofmx-1{list-style-type:none}ol.lst-kix_dgiphh7kofmx-2{list-style-type:none}ol{margin:0;padding:0}.c9{color:#6ba539;font-size:15pt;background-color:#ffffff;font-weight:bold}.c0{line-height:1.5;padding-top:15pt;direction:ltr;padding-bottom:17pt}.c7{max-width:468pt;background-color:#ffffff;padding:72pt 72pt 72pt 72pt}.c6{line-height:1.5;direction:ltr;padding-bottom:17pt}.c10{color:#6ba539;font-size:15pt;background-color:#ffffff}.c3{line-height:1.4;direction:ltr;padding-bottom:8pt}.c12{color:#116644;background-color:#ffffff;font-family:"Verdana"}.c14{line-height:1.4;direction:ltr;padding-bottom:11pt}.c11{color:#aaaaaa;background-color:#f7f7f7;font-family:"Verdana"}.c2{color:#489b00;font-size:12pt;background-color:#ffffff}.c1{color:#615f5e;background-color:#f8f8f8;font-family:"Verdana"}.c4{color:#615f5e;font-size:12pt;background-color:#ffffff}.c8{line-height:1.375;direction:ltr;padding-bottom:8pt}.c5{color:inherit;text-decoration:inherit}.c17{font-style:italic}.c13{height:11pt}.c16{margin-left:22pt}.c15{direction:ltr}.title{padding-top:0pt;line-height:1.15;text-align:left;color:#000000;font-size:21pt;font-family:"Trebuchet MS";padding-bottom:0pt}.subtitle{padding-top:0pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:13pt;font-family:"Trebuchet MS";padding-bottom:10pt}li{color:#000000;font-size:11pt;font-family:"Arial"}p{color:#000000;font-size:11pt;margin:0;font-family:"Arial"}h1{padding-top:10pt;line-height:1.15;text-align:left;color:#000000;font-size:16pt;font-family:"Trebuchet MS";padding-bottom:0pt}h2{padding-top:10pt;line-height:1.15;text-align:left;color:#000000;font-size:13pt;font-family:"Trebuchet MS";font-weight:bold;padding-bottom:0pt}h3{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-size:12pt;font-family:"Trebuchet MS";font-weight:bold;padding-bottom:0pt}h4{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-size:11pt;text-decoration:underline;font-family:"Trebuchet MS";padding-bottom:0pt}h5{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-size:11pt;font-family:"Trebuchet MS";padding-bottom:0pt}h6{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:11pt;font-family:"Trebuchet MS";padding-bottom:0pt}</style></head><body class="c7"><h2 class="c14"><a name="h.ylj6bebpf3u8"></a><span class="c10">Final: Final.1</span></h2><p class="c6"><span class="c4">Problems 1 through 3 are an exercise in running mongod&#39;s, replica sets, and an exercise in testing of replica set </span><span class="c4 c17">rollbacks</span><span class="c4">, which can occur when a former primary rejoins a set after it has previously had a failure.</span></p><p class="c0"><span class="c4">Get the </span><span class="c2"><a class="c5" href="https://education.10gen.com/static/m102-july-2013/handouts/a.c7527cdb3804.sh">a.sh</a></span><span class="c4">&nbsp;and </span><span class="c2"><a class="c5" href="https://education.10gen.com/static/m102-july-2013/handouts/a.aa6513503fc9.js">a.js</a></span><span class="c4">&nbsp;files from the course site. Use </span><span class="c2"><a class="c5" href="https://education.10gen.com/static/m102-july-2013/handouts/a.e1cd4759e0c5.bat">a.bat</a></span><span class="c4">&nbsp;instead of a.sh on Windows.</span></p><p class="c0"><span class="c4">Start a 3 member replica set (with default options for each member, all are peers). (a.sh will start the mongod&#39;s for you if you like.)</span></p><p class="c3"><span class="c1">$ # if on unix:<br>$ chmod +x a.sh<br>$ ./a.sh<br></span></p><p class="c8"><span class="c4">Then run:</span></p><p class="c3"><span class="c1">$ mongo --shell --port 27003 a.js<br>&gt; // ourinit() will initiate the set for us.<br>&gt; // to see its source code type without the parentheses:<br>&gt; ourinit<br>&gt;<br>&gt; // now execute it:<br>&gt; ourinit()<br></span></p><p class="c6"><span class="c4">We will now do a test of replica set rollbacks. This is the case where data never reaches a majority of the set. We&#39;ll test a couple scenarios.</span></p><p class="c0"><span class="c4">Take a look at the method </span><span class="c1">testRollback()</span><span class="c4">&nbsp;in a.js and what it does. Then, on</span><span class="c1">localhost:27003</span><span class="c4">, with that member primary, run:</span></p><p class="c3"><span class="c1">&gt; testRollback()<br></span></p><p class="c6"><span class="c4">Note: if 27003 is not primary, make it primary -- using </span><span class="c1">rs.stepDown()</span><span class="c4">&nbsp;(perhaps also</span><span class="c1">rs.freeze()</span><span class="c4">) for example.</span></p><p class="c0"><span class="c4">At this point the mongod&#39;s on 27001 and 27002 are shut down. See the </span><span class="c1">a.js</span><span class="c4">&nbsp;source code. We now solely have our 27003 member running. If you wait a while, it will &quot;step down&quot; as it does not see a majority. Regardless, let&#39;s continue, no need to wait. First check that only one </span><span class="c1">mongod</span><span class="c4">&nbsp;is running:</span></p><p class="c3"><span class="c1">$ ps -A | grep mongod<br>&hellip;<br></span></p><p class="c6"><span class="c4">Now, let&#39;s restart the two mongod&#39;s that are shut down. If you like you can cut and paste the two relevant mongod invocations from </span><span class="c1">a.sh</span><span class="c4">.</span></p><p class="c0"><span class="c4">Now run </span><span class="c1">ps</span><span class="c4">&nbsp;again and verify three are up:</span></p><p class="c3"><span class="c1">$ ps -A | grep mongod<br></span></p><p class="c6"><span class="c4">Now, we want to see if any data that we attempted to insert isn&#39;t there. Go into the shell to any member of the set. Use </span><span class="c1">rs.status()</span><span class="c4">&nbsp;to check state. Be sure the member is &quot;caught up&quot; to the latest optime (if it&#39;s a secondary). Also on a secondary you might need to invoke </span><span class="c1">rs.slaveOk()</span><span class="c4">before doing a query.)</span></p><p class="c0"><span class="c4">Now run:</span></p><p class="c3"><span class="c1">&gt; db.foo.find()<br></span></p><p class="c8"><span class="c4">to see what data is there after the set recovered from the two outages. How many documents do you have?</span></p><p class="c3"><span class="c11">Ans:</span></p><p class="c3 c16"><span class="c12">9</span></p><p class="c8 c13"><span class="c9"></span></p><p class="c13 c15"><span class="c9"></span></p></body></html>