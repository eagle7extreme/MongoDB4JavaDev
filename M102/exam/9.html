<html><head><title>Untitled document</title><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">ol{margin:0;padding:0}.c1{color:#615f5e;font-size:12pt;background-color:#ffffff;font-weight:bold}.c4{line-height:1.5;padding-top:15pt;direction:ltr;padding-bottom:17pt}.c11{color:#aaaaaa;background-color:#f7f7f7;font-family:"Verdana";font-weight:bold}.c6{color:#116644;background-color:#ffffff;font-family:"Verdana";font-weight:bold}.c2{line-height:1.4;direction:ltr;margin-left:22pt;padding-bottom:8pt}.c5{color:#615f5e;background-color:#f8f8f8;font-family:"Verdana";font-weight:bold}.c0{color:#489b00;font-size:12pt;background-color:#ffffff;font-weight:bold}.c14{line-height:1.4;direction:ltr;margin-left:22pt;padding-bottom:11pt}.c8{line-height:1.5;direction:ltr;padding-bottom:17pt}.c7{color:#6ba539;font-size:15pt;background-color:#ffffff}.c10{max-width:468pt;background-color:#ffffff;padding:72pt 72pt 72pt 72pt}.c15{color:inherit;text-decoration:inherit}.c3{height:11pt;direction:ltr}.c9{font-style:italic}.c13{font-weight:bold}.c12{height:11pt}.title{padding-top:0pt;line-height:1.15;text-align:left;color:#000000;font-size:21pt;font-family:"Trebuchet MS";padding-bottom:0pt}.subtitle{padding-top:0pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:13pt;font-family:"Trebuchet MS";padding-bottom:10pt}li{color:#000000;font-size:11pt;font-family:"Arial"}p{color:#000000;font-size:11pt;margin:0;font-family:"Arial"}h1{padding-top:10pt;line-height:1.15;text-align:left;color:#000000;font-size:16pt;font-family:"Trebuchet MS";padding-bottom:0pt}h2{padding-top:10pt;line-height:1.15;text-align:left;color:#000000;font-size:13pt;font-family:"Trebuchet MS";font-weight:bold;padding-bottom:0pt}h3{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-size:12pt;font-family:"Trebuchet MS";font-weight:bold;padding-bottom:0pt}h4{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-size:11pt;text-decoration:underline;font-family:"Trebuchet MS";padding-bottom:0pt}h5{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-size:11pt;font-family:"Trebuchet MS";padding-bottom:0pt}h6{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:11pt;font-family:"Trebuchet MS";padding-bottom:0pt}</style></head><body class="c10"><h2 class="c14"><a name="h.djhovpadzosm"></a><span class="c7">Final: Final.9</span></h2><p class="c8"><span class="c1">Now that the config server from question #8 is up and running, we will restore the two shards (&quot;s1&quot; and &quot;s2&quot;).</span></p><p class="c4"><span class="c1">Use </span><span class="c5">mongorestore</span><span class="c1">&nbsp;to restore the data for each shard. The shards were mongodump&#39;d with the</span><span class="c5">--oplog</span><span class="c1">&nbsp;option, so you will want to use </span><span class="c5">--oplogReplay</span><span class="c1">&nbsp;on your </span><span class="c5">mongorestore</span><span class="c1">command line on each of these restores (note we didn&#39;t use that for the config server restore as config servers are not replica sets).</span></p><p class="c4"><span class="c1">If we inspect our restored config db, we see this in db.shards:</span></p><p class="c2"><span class="c5">~/dba/final $ mongo localhost:27019/config<br>MongoDB shell version: 2.4.3<br>connecting to: localhost:27019/config<br>configsvr&gt; db.shards.find()<br>{ &quot;_id&quot; : &quot;s1&quot;, &quot;host&quot; : &quot;s1/genome_svr1:27501,genome_svr2:27502,genome_svr2:27503&quot; }<br>{ &quot;_id&quot; : &quot;s2&quot;, &quot;host&quot; : &quot;s2/genome_svr4:27601,genome_svr5:27602,genome_svr5:27603&quot; }<br></span></p><p class="c8"><span class="c1">From this we know when we run a </span><span class="c5">mongos</span><span class="c1">&nbsp;for the cluster, it will expect the first shard to be a replica set named &quot;s1&quot;, and the second to be a replica set named &quot;s2&quot;, and also to be able to be able to resolve and connect to at least one of the seed hostnames for each shard. If we were restoring this cluster as &quot;itself&quot;, it would be best to assign the hostnames &quot;genome_svr1&quot; etc. to the appropriate IP addresses in DNS, and not change </span><span class="c5">config.shard</span><span class="c1">. However, for this problem, our job is not to restore the cluster, but rather to create a new temporary datamart initialized with this dataset.</span></p><p class="c4"><span class="c1">Thus instead we will update the config.shards metadata to point to the locations of our new shard servers. Update the config.shards collection such that your output is:</span></p><p class="c2"><span class="c5">configsvr&gt; db.shards.find()<br>{ &quot;_id&quot; : &quot;s1&quot;, &quot;host&quot; : &quot;localhost:27501&quot; }<br>{ &quot;_id&quot; : &quot;s2&quot;, &quot;host&quot; : &quot;localhost:27601&quot; }<br>configsvr&gt; <br></span></p><p class="c8"><span class="c1">Be sure when you do this nothing is running except the single config server. mongod and mongos processes cache metadata, so this is important. After the update restart the config server itself for the same reason.</span></p><p class="c4"><span class="c1">Now start a mongod for each shard -- one on port 27501 for shard &quot;s1&quot; and on port 27601 for shard &quot;s2&quot;. At this point if you run ps you should see three mongod&#39;s -- one for each shard, and one for our config server. Note they need not be replica sets, but just regular mongod&#39;s, as we did not begin our </span><span class="c5">host</span><span class="c1">&nbsp;string in config.shards with </span><span class="c5 c9">setname</span><span class="c5">/</span><span class="c1">.</span></p><p class="c4"><span class="c1">Then next step is to start a </span><span class="c5">mongos</span><span class="c1">&nbsp;for the cluster. However, you will get an error when you do this if you are running mongodb 2.4 or later (which you almost certainly are). This happens because the mongodump for this exercise was generated from a sharded cluster running mongodb 2.2. Changes to the meta-data format in later versions require us to run a simple upgrade procedure for this assignment. If you are interested in more detail please view the</span><span class="c0"><a class="c15" href="http://docs.mongodb.org/manual/release-notes/2.4-upgrade/#upgrade-cluster">release notes</a></span><span class="c1">&nbsp;on this issue. In short, you will need to stop the balancer and run mongos with the --upgrade option in order to upgrade the cluster:</span><span class="c5">mongo --port 27019 --eval &quot;sh.stopBalancer()&quot;</span></p><p class="c4"><span class="c5">mongos --upgrade --configdb localhost:27019</span></p><p class="c4"><span class="c1">Connect to the mongos with a </span><span class="c5">mongo</span><span class="c1">&nbsp;shell. Run this:</span></p><p class="c2"><span class="c5">&gt; use snps<br>&gt; db.elegans.aggregate([{$match:{N2:&quot;T&quot;}},{$group:{_id:&quot;$N2&quot;,n:{$sum:1}}}]).result[0].n<br></span></p><p class="c8"><span class="c1">Enter the number output for </span><span class="c5">n</span><span class="c1">.</span></p><p class="c2"><span class="c11">Ans:</span></p><p class="c2"><span class="c6">47664</span></p><p class="c2 c12"><span class="c7 c13"></span></p><p class="c3"><span></span></p></body></html>